# ============================
# Final image: ONLY Celery Worker for Hunyuan3D
# ============================

FROM matteopostiferi/hunyuan-base:latest

WORKDIR /workspace

# ğŸ“¥ Clone repositories
RUN echo "ğŸ” Cloning repositories..." && \
    git clone https://github.com/MatteoPostiferi999/ThesisProject.git ThesisProject && \
    git clone https://github.com/deepbeepmeep/Hunyuan3D-2GP.git Hunyuan3D-2GP

# ğŸ©¹ Apply patches to Hunyuan3D-2GP
RUN echo "ğŸ©¹ Applying patches..." && \
    cd Hunyuan3D-2GP && \
    sed -i 's/mmgp/hy3dgen/g' gradio_app.py && \
    sed -i 's/mmgp/hy3dgen/g' hy3dgen/shapegen/models/autoencoders/surface_extractors.py && \
    sed -i '/from hy3dgen import offload/d' hy3dgen/shapegen/models/autoencoders/surface_extractors.py && \
    echo "âœ… Patches applied successfully"

# ğŸ“¦ Install ONLY Hunyuan3D-2GP (no Django dependencies)
RUN echo "ğŸ“¦ Installing Hunyuan3D-2GP..." && \
    cd Hunyuan3D-2GP && \
    pip install -e . && \
    echo "âœ… Hunyuan3D-2GP installed successfully"

# ğŸ§  Update environment variables
ENV PYTHONPATH="/workspace/Hunyuan3D-2GP:/workspace/ThesisProject/3d-webgen/backend:$PYTHONPATH"

# ğŸ§ª Verify Hunyuan3D only
COPY <<EOF /tmp/verify_hunyuan.py
try:
    import hy3dgen
    print('âœ… hy3dgen base import successful')
    
    from hy3dgen.shapegen import Hunyuan3DDiTFlowMatchingPipeline
    print('âœ… Hunyuan3DDiTFlowMatchingPipeline import successful')
    
    import torch
    print(f'âœ… PyTorch {torch.__version__} with CUDA: {torch.cuda.is_available()}')
    
    import celery
    print(f'âœ… Celery {celery.__version__} ready')
    
    print('ğŸ‰ Celery Worker container verified!')
    
except Exception as e:
    print(f'âš ï¸ Verification error: {str(e)}')
    import traceback
    traceback.print_exc()
EOF

RUN python3 /tmp/verify_hunyuan.py && rm /tmp/verify_hunyuan.py

# ğŸ”§ Setup working directories for Celery
RUN mkdir -p /app/models /app/outputs

# ğŸš€ Celery worker entry point
COPY <<EOF /usr/local/bin/run-celery-worker
#!/bin/bash
cd /workspace/ThesisProject/3d-webgen/backend
exec celery -A backend worker --loglevel=info --pool=solo
EOF

RUN chmod +x /usr/local/bin/run-celery-worker

# ğŸ’¡ Usage information
COPY <<EOF /workspace/README.txt
ğŸ‰ Celery Worker Container Ready!

ğŸš€ Start Celery Worker:
   celery -A backend worker --loglevel=info --pool=solo

ğŸ“ Important paths:
   - ThesisProject: /workspace/ThesisProject/3d-webgen/backend
   - Hunyuan3D: /workspace/Hunyuan3D-2GP
   - Models cache: /app/models  
   - Outputs: /app/outputs

ğŸ”§ Environment:
   - Python: /usr/bin/python3
   - PYTHONPATH includes both projects
   - CUDA enabled for GPU processing
EOF

# ğŸ‘Ÿ Default command: Start Celery Worker
CMD ["celery", "-A", "backend", "worker", "--loglevel=info", "--pool=solo"]