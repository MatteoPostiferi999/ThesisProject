# ============================
# Final image: adds Hunyuan3D and ThesisProject
# ============================

FROM matteopostiferi/hunyuan3d-2gp-base:latest

WORKDIR /workspace

# ğŸ“¥ Clone repositories
RUN echo "ğŸ” Cloning repositories..." && \
    git clone https://github.com/MatteoPostiferi999/ThesisProject.git ThesisProject && \
    git clone https://github.com/deepbeepmeep/Hunyuan3D-2GP.git Hunyuan3D-2GP

# ğŸ©¹ Apply patches to Hunyuan3D-2GP
RUN echo "ğŸ©¹ Applying patches..." && \
    cd Hunyuan3D-2GP && \
    sed -i 's/mmgp/hy3dgen/g' gradio_app.py && \
    sed -i 's/mmgp/hy3dgen/g' hy3dgen/shapegen/models/autoencoders/surface_extractors.py && \
    sed -i '/from hy3dgen import offload/d' hy3dgen/shapegen/models/autoencoders/surface_extractors.py && \
    echo "âœ… Patches applied successfully"

# ğŸ“¦ Install ThesisProject backend requirements
RUN echo "ğŸ“¦ Installing ThesisProject requirements..." && \
    if [ -f "ThesisProject/3d-webgen/backend/requirements_lambda.txt" ]; then \
        pip install --no-cache-dir -r ThesisProject/3d-webgen/backend/requirements_lambda.txt || \
        echo "âš ï¸ Some ThesisProject requirements failed"; \
    else \
        echo "âš ï¸ requirements_lambda.txt not found"; \
    fi

# ğŸ“¦ Install Hunyuan3D-2GP requirements and package
RUN echo "ğŸ“¦ Installing Hunyuan3D-2GP..." && \
    cd Hunyuan3D-2GP && \
    if [ -f "requirements.txt" ]; then \
        pip install --no-cache-dir -r requirements.txt --no-deps || \
        echo "âš ï¸ Some Hunyuan3D requirements failed"; \
    fi && \
    pip install -e . && \
    echo "âœ… Hunyuan3D-2GP installed successfully"

# ğŸ§  Update environment variables
ENV PYTHONPATH="/workspace/Hunyuan3D-2GP:/workspace/ThesisProject/3d-webgen/backend:$PYTHONPATH"

# ğŸ§ª Final verification
COPY <<EOF /tmp/verify_final.py
try:
    import hy3dgen
    print('âœ… hy3dgen base import successful')
    
    from hy3dgen.shapegen import Hunyuan3DDiTFlowMatchingPipeline
    print('âœ… Hunyuan3DDiTFlowMatchingPipeline import successful')
    
    import torch
    print(f'âœ… PyTorch {torch.__version__} with CUDA: {torch.cuda.is_available()}')
    
    print('ğŸ‰ All Hunyuan3D components verified!')
    
except Exception as e:
    print(f'âš ï¸ Verification error: {str(e)}')
    import traceback
    traceback.print_exc()
EOF

RUN echo "ğŸ§ª Final verification..." && python3 /tmp/verify_final.py && rm /tmp/verify_final.py

# ğŸ“ Copy additional project files (if needed)
# COPY ai ./ai
# COPY config ./config

# ğŸ”§ Setup working directories
RUN mkdir -p /workspace/data /workspace/output /workspace/models

# ğŸ·ï¸ Metadata
LABEL hunyuan3d.version="2GP"
LABEL thesis.project="3d-webgen"

# ğŸš€ Entry points for different services
# Django server
COPY <<EOF /usr/local/bin/run-django
#!/bin/bash
cd /workspace/ThesisProject/3d-webgen/backend
python manage.py runserver 0.0.0.0:8000
EOF

# Celery worker
COPY <<EOF /usr/local/bin/run-celery
#!/bin/bash
cd /workspace/ThesisProject/3d-webgen/backend
celery -A backend.celery worker --loglevel=info
EOF

RUN chmod +x /usr/local/bin/run-django /usr/local/bin/run-celery

# ğŸ’¡ Usage information
COPY <<EOF /workspace/README.txt
ğŸ‰ Container ready! Available commands:
  
ğŸš€ Run Django server:
   run-django
   
ğŸš€ Run Celery worker:  
   run-celery
   
ğŸ Python interactive:
   python3
   
ğŸ”§ Custom command:
   python3 your_script.py

ğŸ“ Important paths:
   - ThesisProject: /workspace/ThesisProject
   - Hunyuan3D: /workspace/Hunyuan3D-2GP
   - Data: /workspace/data
   - Output: /workspace/output
   - Models: /workspace/models
EOF

# ğŸ‘Ÿ Default command - show usage
CMD ["cat", "/workspace/README.txt"]